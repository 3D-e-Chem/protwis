{% extends "home/base.html" %}
{% load staticfiles %}
{% load structure_extras %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/structure_browser.css' %}" type="text/css" />
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/dataTables.tableTools.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.columnFilter.js' %}"> </script>
    <script src="{% static 'home/js/selection.js' %}"> </script>

    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
            var table = $('#structures').DataTable({
                'scrollX': true,
                'scrollY': 600,
                'bScrollCollapse': true,
                'paging': false,
                'orderCellsTop': true,
                'autoWidth': true,
                'dom': 'T<"clear">lfrtip',
                'order': [[11, "asc"]], // order by date
                'aoColumnDefs': [
                    { 'sType': 'string', 'aTargets': [0] },
                    { 'sType': 'string', 'aTargets': [9] },
                ],
                'tableTools': {
                    "sRowSelect": "multi",
                    "aButtons": ["select_all", "select_none"]
                },
                initComplete: function () {
                    $('#structures').dataTable().columnFilter({
                        sPlaceHolder: "head:after",
                        sRangeFormat: "{from}:{to}",
                        aoColumns: [
                            { type: "select" }, // protein name
                            { type: "select" }, // class
                            { type: "select" }, // species
                            { type: "text" }, // pdb code
                            { type: "number-range" }, // resolution
                            { type: "text" }, // preferred chain
                            { type: "text" }, // stabilizing agent - left as type-in for now
                            { type: "text" }, // endogenous ligand name
                            { type: "text" }, // endogenous ligand type
                            { type: "text" }, // x-ray ligand
                            { type: "text" }, // reference
                            { type: "date-range" }, // publication date
                        ]
                    });
                }
            });
            $.datepicker.regional[""].dateFormat = "yy-mm-dd";
            $.datepicker.setDefaults($.datepicker.regional['']);
            $('#structures tbody').on('click', 'tr', function () {
                $(this).toggleClass('selected');
            });
            $('#ref_btn').click(function () {
                if ( table.rows('.selected').data().length != 1 ) {
                    alert("Can only use one reference structure!!!");
                }
                else {
                    AddToSelection('reference', 'structure', table.rows('.selected').data()[0][3]);
                }

            });
            $('#alt_btn').click(function () {
                var selected_data = table.rows('.selected').data();
                for (i = 0; i < selected_data.length; i++) {
                    AddToSelection('targets', 'structure', selected_data[i][3]);
                }
            });
            });
    </script> 
{% endblock %}

{% block content %}

    <div class="btn-group">
        <a id="ref_btn" class="btn btn-primary btn-mini" href="#"><i class="icon-download icon-white"></i>Select as reference</a>
    </div>
    <div class="btn-group">
        <a id="alt_btn" class="btn btn-primary btn-mini " href="#"><i class="icon-download icon-white"></i>Select as altering</a>
    </div>
    <div class="btn-group">
        <a class="btn btn-primary btn-mini " href="/structure/superposition_workflow_index">Go to superposition workflow</a>
    </div>
    <br />
    <br />
    {% if structures %}              
        <div style="padding-top: 0px; font-size: 10px; white-space: nowrap;">
            <table width="100%" class="display" id="structures">
                <thead>
                    <tr>
                        <th class="protein-th">Protein name</th>
                        <th class="protein-th">Protein class</th>
                        <th class="protein-th">Species</th>
                        <th class="pdb-th">PDB code</th>
                        <th class="pdb-th">Resolution</th>
                        <th class="pdb-th">Pre. chain</th>
                        <th class='pdb-th'>Aux. proteins</th>
                        <th class="ligand-th">Endo. ligand</th>
                        <th class="ligand-th">Endo. lig. type</th>
                        <th class="ligand-th">X-ray ligand</th>
                        <th class="pub-th">Reference</th>
                        <th class="pub-th">Date</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for structure in structures.select_related.all %}
                    <tr>
                        <td>{{ structure.protein_conformation.protein.family.name|safe }}</td>
                        <td>{{ structure.protein_conformation.protein.get_protein_class }}</td>
                        <td>{{ structure.protein_conformation.protein.species.common_name }}</td>
                            <td class="text-center"><a href="{{ structure.pdb_code.index}}">{{ structure.pdb_code.index}}
                        </a></td>
                        <td class="text-center">{{ structure.resolution|floatformat:"1" }}</td>
                        <td class="text-center">{{ structure.preferred_chain }}</td>
                        <td>{{ structure.stabilizing_agents.all|join_attr:"name" }}</td>
                        <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|join_attr:"name" }}</td>
                        <td>{{ structure.protein_conformation.protein.parent.endogenous_ligands.all|join_attr:"properties__ligand_type" }}</td>
                        <td>{{ structure.ligands.all|join_attr:"name"|slice:":20" }}</td>
                        <td>
                            <a href="{{ structure.publication.web_link }}">{{ structure.publication.web_link.index }}</a>
                        </td>
                        <td>{{ structure.publication_date|date:"Y-m-d" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p> Ooops! There is no data to show here yet. </p>
    {% endif %}

{% endblock %}
